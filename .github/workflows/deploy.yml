name: Deploy to Backend Server

on:
    push:
        branches: [main, master]
    workflow_dispatch:

jobs:
    deploy:
        name: Deploy Laravel to DigitalOcean
        runs-on: ubuntu-latest

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Deploy to Server
              uses: appleboy/ssh-action@v1.0.0
              with:
                  host: ${{ secrets.BACKEND_SERVER_IP }}
                  username: root
                  key: ${{ secrets.SSH_PRIVATE_KEY }}
                  script: |
                      echo "Starting deployment..."
                      cd /var/www/html

                      # Pull latest changes
                      git pull origin ${{ github.ref_name }}

                      # Install/update dependencies
                      export COMPOSER_ALLOW_SUPERUSER=1
                      export HOME=/root
                      composer install --no-interaction --optimize-autoloader --no-dev

                      # Update .env file with database credentials
                      cat > .env <<'EOF'
                      APP_NAME=Laravel
                      APP_ENV=production
                      APP_KEY=${{ secrets.APP_KEY }}
                      APP_DEBUG=false
                      APP_URL=${{ secrets.APP_URL }}

                      LOG_CHANNEL=stack
                      LOG_LEVEL=error

                      DB_CONNECTION=mysql
                      DB_HOST=${{ secrets.DB_HOST }}
                      DB_PORT=${{ secrets.DB_PORT }}
                      DB_DATABASE=${{ secrets.DB_DATABASE }}
                      DB_USERNAME=${{ secrets.DB_USERNAME }}
                      DB_PASSWORD=${{ secrets.DB_PASSWORD }}

                      BROADCAST_DRIVER=log
                      CACHE_DRIVER=file
                      FILESYSTEM_DRIVER=local
                      QUEUE_CONNECTION=sync
                      SESSION_DRIVER=file
                      SESSION_LIFETIME=120
                      EOF

                      # Generate key if not set
                      if grep -q "APP_KEY=$" .env; then
                        php artisan key:generate --force
                      fi

                      # Run migrations
                      php artisan migrate --force

                      # Clear and cache config
                      php artisan config:cache
                      php artisan route:cache
                      php artisan view:cache

                      # Set permissions
                      chown -R www-data:www-data /var/www/html
                      chmod -R 755 /var/www/html
                      chmod -R 775 /var/www/html/storage
                      chmod -R 775 /var/www/html/bootstrap/cache

                      # Restart services
                      systemctl restart php8.2-fpm nginx

                      echo "âœ… Deployment completed successfully!"

            - name: Deployment Status
              if: always()
              run: |
                  if [ ${{ job.status }} == 'success' ]; then
                    echo "ðŸŽ‰ Deployment successful!"
                  else
                    echo "âŒ Deployment failed!"
                    exit 1
                  fi
